NOP

// Error Handling and Recovery Demo
// Demonstrates interrupt handling and error recovery

TF #1

SET P1 LPOS    // Home
SET P2 LPOS    // Work position
SET P3 LPOS    // Error recovery position

// Status flags
SET I1 0       // Error code (0=OK)
SET I2 0       // Retry counter
SET I3 3       // Max retries

// Initialize
OUT OT#1=OFF   // Fault indicator OFF
OUT OT#2=ON    // System ready

// Enable interrupts
IRQON LEV=1 IN#10=ON L80    // Emergency stop interrupt

L10
// Main work cycle
IF I1 <> 0 L50    // Check for errors

// Approach work position
MOVJ P2 VJ=80 ACC=80 CNT=0

// Check sensor before work
IF IN#1 = OFF L40    // Part not detected

// Perform work
OUT OT#3=ON    // Work signal
MOVL P2 VL=200 ACC=30 CNT=0 OFFSET=0,0,-50,0,0,0
MOVL P2 VL=200 ACC=30 CNT=0
OUT OT#3=OFF

// Work complete
GOTO L90

L40
// Part not detected error
SET I1 1
ADD I2 1
IF I2 > I3 L50    // Max retries exceeded

// Retry
MOVJ P1 VJ=50 ACC=80 CNT=0
SET I1 0
GOTO L10

L50
// Error state
OUT OT#1=ON    // Fault indicator
OUT OT#2=OFF   // System not ready

// Move to safe position
MOVJ P3 VJ=30 ACC=50 CNT=0

// Wait for reset
WAIT IN#5=ON T=60000    // Reset button

// Clear error
SET I1 0
SET I2 0
OUT OT#1=OFF
OUT OT#2=ON

GOTO L10

L80
// Emergency stop handler
OUT OT#1=ON
OUT OT#2=OFF
OUT OT#3=OFF
SET I1 99
RET

L90
// Cycle complete
MOVJ P1 VJ=100 ACC=100 CNT=0

END
